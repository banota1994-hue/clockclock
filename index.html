<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <title>Notion Cute Clock + Qatar Prayer Times</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Cairo', sans-serif;
      background: transparent;
    }

    /* Card (visible on white Notion background) */
    .card {
      width: 100%;
      max-width: 780px;
      box-sizing: border-box;
      border-radius: 18px;
      padding: 16px 16px 14px;
      position: relative;
      overflow: hidden;

      /* kawaii red/pink, readable */
      background: linear-gradient(135deg, #fff5f7, #ffe9ee);
      border: 1px solid rgba(176, 45, 65, 0.18);
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      color: #4a1d25;
    }

    /* subtle dotted pattern */
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(rgba(176,45,65,0.10) 1px, transparent 1px);
      background-size: 16px 16px;
      opacity: 0.35;
      pointer-events: none;
    }

    /* Soft top highlight */
    .card::after {
      content: "";
      position: absolute;
      top: -60px;
      left: -60px;
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(176,45,65,0.14), transparent 60%);
      pointer-events: none;
    }

    .content {
      position: relative; /* above pattern */
      z-index: 1;
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(176, 45, 65, 0.16);
      box-shadow: 0 6px 16px rgba(0,0,0,0.05);
      font-size: 13px;
      white-space: nowrap;
      color: #6a1f2b;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      cursor: pointer;
      border: 1px solid rgba(176, 45, 65, 0.20);
      background: rgba(255,255,255,0.75);
      color: #6a1f2b;
      border-radius: 12px;
      padding: 7px 10px;
      font-family: 'Cairo', sans-serif;
      font-size: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.04);
      user-select: none;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      background: rgba(176,45,65,0.10);
      border-color: rgba(176,45,65,0.26);
      font-weight: 700;
    }

    .greeting {
      font-size: 18px;
      font-weight: 700;
      margin: 6px 0 10px;
      color: #5d1623;
    }

    .time {
      font-size: 46px;
      font-weight: 800;
      letter-spacing: 2px;
      line-height: 1.05;
      color: #b02d41;
      text-shadow: 0 6px 18px rgba(176,45,65,0.12);
    }

    .date {
      margin-top: 8px;
      font-size: 14px;
      opacity: 0.95;
      color: #6a1f2b;
    }

    .adhanBox {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 10px;
      align-items: stretch;
    }

    .panel {
      border-radius: 16px;
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(176, 45, 65, 0.14);
      padding: 10px 12px;
      text-align: right;
      box-shadow: 0 8px 22px rgba(0,0,0,0.04);
    }

    .panelTitle {
      font-size: 12px;
      opacity: 0.95;
      margin-bottom: 6px;
      color: #6a1f2b;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(176,45,65,0.18);
      background: rgba(176,45,65,0.08);
      color: #7a2230;
      white-space: nowrap;
    }

    .nextPrayer {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      font-weight: 800;
    }

    .nextPrayer .name {
      font-size: 16px;
      color: #5d1623;
    }

    .nextPrayer .countdown {
      font-size: 16px;
      letter-spacing: 1px;
      color: #b02d41;
    }

    .progressWrap {
      margin-top: 8px;
      height: 10px;
      background: rgba(176,45,65,0.10);
      border: 1px solid rgba(176,45,65,0.12);
      border-radius: 999px;
      overflow: hidden;
    }

    .progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(176,45,65,0.35), rgba(176,45,65,0.70));
      border-radius: 999px;
      transition: width 0.25s ease;
    }

    .times {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px 10px;
      font-size: 12px;
      margin-top: 6px;
      color: #5d1623;
    }

    .times .item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      opacity: 0.98;
      padding: 4px 6px;
      border-radius: 10px;
      background: rgba(176,45,65,0.05);
      border: 1px solid rgba(176,45,65,0.08);
    }

    .hint {
      font-size: 11px;
      opacity: 0.9;
      margin-top: 7px;
      text-align: center;
      color: #7a2230;
    }

    .footerTiny {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(93,22,35,0.75);
      text-align: center;
    }

    /* responsive */
    @media (max-width: 560px) {
      .adhanBox { grid-template-columns: 1fr; }
      .time { font-size: 42px; }
    }
  </style>
</head>

<body>
  <div class="card" id="card">
    <div class="content">
      <div class="top">
        <div class="pill" id="locPill">ğŸ“ Ø§Ù„Ø¯ÙˆØ­Ø©</div>

        <div class="controls">
          <button class="btn" id="toggleFmt">12/24</button>
          <button class="btn primary" id="enableSound">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
          <button class="btn" id="refreshTimes">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</button>
        </div>
      </div>

      <div id="greeting" class="greeting"></div>
      <div id="time" class="time"></div>
      <div id="date" class="date"></div>

      <div class="adhanBox">
        <div class="panel">
          <div class="panelTitle">
            <span>Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</span>
            <span class="badge" id="methodBadge">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù‚Ø·Ø±ÙŠ</span>
          </div>

          <div class="nextPrayer">
            <div class="name" id="nextPrayerName">â€”</div>
            <div class="countdown" id="nextPrayerCountdown">â€”</div>
          </div>

          <div class="progressWrap" aria-label="progress to next prayer">
            <div class="progressBar" id="progressBar"></div>
          </div>

          <div class="hint" id="statusHint">Ø¬Ø§Ù‡Ø²Ø© âœ¨</div>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <span>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ÙŠÙˆÙ…</span>
            <span class="badge" id="tzBadge">Asia/Qatar</span>
          </div>

          <div class="times" id="timesGrid"></div>
          <div class="hint" id="apiHint">Ø§Ù„Ù…ØµØ¯Ø±: Qatar Calendar (method=10)</div>
        </div>
      </div>

      <div class="footerTiny">ğŸ€ ÙƒÙŠÙˆØªâ€¦ Ø¨Ø³ Ø¹Ù…Ù„ÙŠØ©</div>
    </div>
  </div>

<script>
/* =========================
   Preferences & Helpers
========================= */
const prefs = {
  use24h: localStorage.getItem("clock_use24h") === "1",
  soundEnabled: localStorage.getItem("adhan_sound_enabled") === "1",
};

const els = {
  greeting: document.getElementById("greeting"),
  time: document.getElementById("time"),
  date: document.getElementById("date"),
  locPill: document.getElementById("locPill"),
  timesGrid: document.getElementById("timesGrid"),
  nextPrayerName: document.getElementById("nextPrayerName"),
  nextPrayerCountdown: document.getElementById("nextPrayerCountdown"),
  progressBar: document.getElementById("progressBar"),
  statusHint: document.getElementById("statusHint"),
  toggleFmt: document.getElementById("toggleFmt"),
  enableSound: document.getElementById("enableSound"),
  refreshTimes: document.getElementById("refreshTimes"),
};

function pad(n){ return n < 10 ? "0" + n : "" + n; }

function formatClock(date){
  const h = date.getHours();
  const m = date.getMinutes();

  if (prefs.use24h) return `${pad(h)}:${pad(m)}`;

  const isPM = h >= 12;
  let hh = h % 12 || 12;
  return `${pad(hh)}:${pad(m)} ${isPM ? "PM" : "AM"}`;
}

function formatDateLine(date){
  const options = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
  return date.toLocaleDateString('ar-QA', options);
}

function setGreeting(date){
  const h = date.getHours();
  if (h < 12) els.greeting.textContent = "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸŒ¸";
  else if (h < 17) els.greeting.textContent = "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸ“";
  else els.greeting.textContent = "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸŒ™";
}

function parseHHMMToDate(baseDate, hhmm){
  // hhmm expected "HH:MM" (24h)
  const clean = (hhmm || "").trim().split(" ")[0]; // remove possible " (QATAR)" extras
  const [hh, mm] = clean.split(":").map(x => parseInt(x, 10));
  const d = new Date(baseDate);
  d.setHours(hh, mm, 0, 0);
  return d;
}

function msToHMS(ms){
  const total = Math.max(0, Math.floor(ms / 1000));
  const h = Math.floor(total / 3600);
  const m = Math.floor((total % 3600) / 60);
  const s = total % 60;
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function displayTimeFromHHMM(hhmm){
  // Convert "HH:MM" to preferred output
  const d = parseHHMMToDate(new Date(), hhmm);
  if (prefs.use24h) return `${pad(d.getHours())}:${pad(d.getMinutes())}`;

  let h = d.getHours();
  const m = d.getMinutes();
  const isPM = h >= 12;
  h = h % 12 || 12;
  return `${pad(h)}:${pad(m)} ${isPM ? "PM" : "AM"}`;
}

/* =========================
   Qatar Calendar (AlAdhan)
========================= */
let prayerTimings = null;     // {Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha, ...}
let nextPrayerTarget = null;  // Date
let prevPrayerTarget = null;  // Date
let nextPrayerKey = null;     // "YYYY-MM-DD|NAME"
let lastNotifiedKey = localStorage.getItem("last_notified_prayer_key") || "";

async function fetchQatarPrayerTimes(){
  try {
    els.statusHint.textContent = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØªâ€¦";

    const today = new Date();
    const dd = today.getDate();
    const mm = today.getMonth() + 1;
    const yyyy = today.getFullYear();

    const url = `https://api.aladhan.com/v1/timingsByCity?city=Doha&country=Qatar&method=10&date=${dd}-${mm}-${yyyy}`;
    const res = await fetch(url, { cache: "no-store" });
    const json = await res.json();

    if (!json || !json.data || !json.data.timings) {
      throw new Error("Bad API response");
    }

    prayerTimings = json.data.timings;
    els.locPill.textContent = "ğŸ“ Ø§Ù„Ø¯ÙˆØ­Ø©";
    renderPrayerTimes(new Date());
    els.statusHint.textContent = "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…";
  } catch (e) {
    console.error(e);
    els.statusHint.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª âš ï¸";
  }
}

function renderPrayerTimes(now){
  if (!prayerTimings) return;

  const list = [
    ["Ø§Ù„ÙØ¬Ø±",   prayerTimings.Fajr],
    ["Ø§Ù„Ø´Ø±ÙˆÙ‚",  prayerTimings.Sunrise],
    ["Ø§Ù„Ø¸Ù‡Ø±",   prayerTimings.Dhuhr],
    ["Ø§Ù„Ø¹ØµØ±",   prayerTimings.Asr],
    ["Ø§Ù„Ù…ØºØ±Ø¨",  prayerTimings.Maghrib],
    ["Ø§Ù„Ø¹Ø´Ø§Ø¡",  prayerTimings.Isha],
  ];

  // render grid
  els.timesGrid.innerHTML = "";
  for (const [name, t] of list) {
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `<span>${name}</span><span>${displayTimeFromHHMM(t)}</span>`;
    els.timesGrid.appendChild(item);
  }

  // compute next prayer (exclude sunrise as prayer)
  const prayersOnly = list.filter(x => x[0] !== "Ø§Ù„Ø´Ø±ÙˆÙ‚");

  let next = null;
  let prev = null;

  for (let i = 0; i < prayersOnly.length; i++) {
    const [name, t] = prayersOnly[i];
    const dt = parseHHMMToDate(now, t);
    if (dt > now) {
      next = { name, dt };
      prev = i === 0 ? null : { name: prayersOnly[i-1][0], dt: parseHHMMToDate(now, prayersOnly[i-1][1]) };
      break;
    }
  }

  // if none left today -> next is tomorrow fajr
  if (!next) {
    const tomorrow = new Date(now);
    tomorrow.setDate(now.getDate() + 1);
    const fajrTomorrow = parseHHMMToDate(tomorrow, prayerTimings.Fajr);
    next = { name: "Ø§Ù„ÙØ¬Ø±", dt: fajrTomorrow };
    prev = { name: "Ø§Ù„Ø¹Ø´Ø§Ø¡", dt: parseHHMMToDate(now, prayerTimings.Isha) };
  }

  nextPrayerTarget = next.dt;
  prevPrayerTarget = prev ? prev.dt : null;

  const y = nextPrayerTarget.getFullYear();
  const m = pad(nextPrayerTarget.getMonth() + 1);
  const d = pad(nextPrayerTarget.getDate());
  nextPrayerKey = `${y}-${m}-${d}|${next.name}`;

  // show next line
  const hhmm = `${pad(nextPrayerTarget.getHours())}:${pad(nextPrayerTarget.getMinutes())}`;
  els.nextPrayerName.textContent = `${next.name} â€” ${displayTimeFromHHMM(hhmm)}`;

  // progress baseline: from prev prayer to next prayer
  updateCountdownAndProgress(new Date());
}

function updateCountdownAndProgress(now){
  if (!nextPrayerTarget) return;

  const diff = nextPrayerTarget - now;

  // countdown text
  els.nextPrayerCountdown.textContent = msToHMS(diff);

  // trigger at or after 0
  if (diff <= 0) {
    handlePrayerTimeReached();
    return;
  }

  // progress bar
  let progress = 0;
  if (prevPrayerTarget) {
    const total = nextPrayerTarget - prevPrayerTarget;
    const done = now - prevPrayerTarget;
    if (total > 0) progress = Math.min(1, Math.max(0, done / total));
  } else {
    // if no prev, just keep it subtle
    progress = 0.25;
  }
  els.progressBar.style.width = `${Math.round(progress * 100)}%`;
}

function handlePrayerTimeReached(){
  // Notify once per prayer key
  if (nextPrayerKey && nextPrayerKey !== lastNotifiedKey) {
    lastNotifiedKey = nextPrayerKey;
    localStorage.setItem("last_notified_prayer_key", lastNotifiedKey);

    els.statusHint.textContent = "Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© ğŸŒ™";

    if (prefs.soundEnabled) gentleChime();
  }

  // Refresh timings after a short delay (so we move to next prayer)
  setTimeout(() => {
    renderPrayerTimes(new Date());
    // Also refresh from API once in case day changed or API updates
    // (lightweight and safe)
    fetchQatarPrayerTimes();
  }, 1500);
}

/* =========================
   Gentle sound (WebAudio)
   Needs user interaction to unlock audio.
========================= */
let audioCtx = null;

function ensureAudio(){
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") {
    return audioCtx.resume();
  }
  return Promise.resolve();
}

function gentleChime(){
  // Soft 2-tone chime, no harsh sounds
  if (!audioCtx) return;

  const now = audioCtx.currentTime;

  const master = audioCtx.createGain();
  master.gain.setValueAtTime(0.0001, now);
  master.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
  master.gain.exponentialRampToValueAtTime(0.0001, now + 1.2);
  master.connect(audioCtx.destination);

  function tone(freq, start, dur){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.setValueAtTime(freq, start);

    gain.gain.setValueAtTime(0.0001, start);
    gain.gain.exponentialRampToValueAtTime(1.0, start + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, start + dur);

    osc.connect(gain);
    gain.connect(master);

    osc.start(start);
    osc.stop(start + dur + 0.02);
  }

  tone(880, now + 0.00, 0.35);
  tone(660, now + 0.18, 0.55);
}

/* =========================
   Main clock loop
========================= */
function tick(){
  const now = new Date();
  setGreeting(now);
  els.time.textContent = formatClock(now);
  els.date.textContent = formatDateLine(now);

  updateCountdownAndProgress(now);

  // if midnight passes, refresh daily times
  if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() < 2) {
    fetchQatarPrayerTimes();
  }
}

function startAlignedTicker(){
  tick();
  const now = new Date();
  const msToNextSecond = 1000 - now.getMilliseconds();
  setTimeout(() => {
    tick();
    setInterval(tick, 1000);
  }, msToNextSecond);
}

/* =========================
   UI Controls
========================= */
els.toggleFmt.addEventListener("click", () => {
  prefs.use24h = !prefs.use24h;
  localStorage.setItem("clock_use24h", prefs.use24h ? "1" : "0");
  // re-render times for new format
  renderPrayerTimes(new Date());
  tick();
});

els.enableSound.addEventListener("click", async () => {
  try {
    await ensureAudio();
    prefs.soundEnabled = true;
    localStorage.setItem("adhan_sound_enabled", "1");
    els.statusHint.textContent = "Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù‘Ù„ ğŸ””";
    // Play a tiny test chime so user knows it's working
    gentleChime();
    // Update button style/state
    els.enableSound.textContent = "ğŸ”” Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„";
  } catch (e) {
    console.error(e);
    els.statusHint.textContent = "Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£ÙØ¹Ù„ Ø§Ù„ØµÙˆØª âš ï¸";
  }
});

els.refreshTimes.addEventListener("click", () => {
  fetchQatarPrayerTimes();
});

/* =========================
   Init
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  // reflect persisted sound preference
  if (prefs.soundEnabled) {
    els.enableSound.textContent = "ğŸ”” Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„";
    // still need user gesture sometimes; we'll keep button so user can re-unlock if needed
  }

  await fetchQatarPrayerTimes();
  startAlignedTicker();
});
</script>
</body>
</html>
