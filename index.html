<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <title>Notion Clock + Adhan</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Cairo', sans-serif;
      background: transparent;
    }

    .card {
      width: 100%;
      max-width: 780px;
      height: 220px;
      padding: 18px 18px 14px;
      border-radius: 16px;
      text-align: center;
      color: #fff;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    .day{
      background: linear-gradient(270deg, #f8c8dc, #ffd9ec, #f8c8dc);
      background-size: 400% 400%;
      animation: gradientMove 10s ease infinite;
    }
    .night{
      background: linear-gradient(135deg, #c07aa0, #8a4f7a, #5d2f57);
      background-size: 300% 300%;
      animation: gradientMove 18s ease infinite;
    }
    @keyframes gradientMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.14);
      font-size: 13px;
      white-space: nowrap;
    }

    .btn {
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.14);
      color: #fff;
      border-radius: 10px;
      padding: 7px 10px;
      font-family: 'Cairo', sans-serif;
      font-size: 12px;
    }
    .btn:active { transform: translateY(1px); }

    .greeting{
      font-size: 18px;
      font-weight: 600;
      margin: 6px 0 10px;
    }

    .time{
      font-size: 48px;
      font-weight: 700;
      letter-spacing: 2px;
      line-height: 1.05;
    }

    .date{
      margin-top: 8px;
      font-size: 14px;
      opacity: 0.95;
    }

    .adhanBox{
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 10px;
      align-items: stretch;
    }

    .panel{
      border-radius: 14px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 10px 12px;
      text-align: right;
    }

    .panelTitle{
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 6px;
    }

    .nextPrayer{
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      font-weight: 700;
    }
    .nextPrayer .name { font-size: 16px; }
    .nextPrayer .countdown { font-size: 16px; letter-spacing: 1px; }

    .times{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px 10px;
      font-size: 12px;
      margin-top: 6px;
    }
    .times .item{
      display: flex;
      justify-content: space-between;
      gap: 8px;
      opacity: 0.95;
    }

    .hint{
      font-size: 11px;
      opacity: 0.85;
      margin-top: 6px;
      text-align: center;
    }
  </style>

  <!-- PrayTimes library (tiny) -->
  <script src="https://unpkg.com/praytimes@2.3.0/PrayTimes.js"></script>
</head>

<body>
  <div id="card" class="card">
    <div class="top">
      <div class="pill" id="locPill">ğŸ“ Ø§Ù„Ø¯ÙˆØ­Ø©</div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="toggleFmt">12/24</button>
        <button class="btn" id="refreshLoc">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      </div>
    </div>

    <div id="greeting" class="greeting"></div>
    <div id="time" class="time"></div>
    <div id="date" class="date"></div>

    <div class="adhanBox">
      <div class="panel">
        <div class="panelTitle">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
        <div class="nextPrayer">
          <div class="name" id="nextPrayerName">â€”</div>
          <div class="countdown" id="nextPrayerCountdown">â€”</div>
        </div>
        <div class="hint" id="methodHint">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„ÙƒÙˆØ¯)</div>
      </div>

      <div class="panel">
        <div class="panelTitle">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="times" id="timesGrid"></div>
        <div class="hint" id="tzHint">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©: Asia/Qatar</div>
      </div>
    </div>
  </div>

<script>
  // ====== Settings ======
  // Default: Doha coords (if geolocation not allowed)
  let coords = { lat: 25.2854, lng: 51.5310 };
  let locationLabel = "Ø§Ù„Ø¯ÙˆØ­Ø©";

  // Method options in PrayTimes:
  // "MWL", "ISNA", "Egypt", "Makkah", "Karachi", "Tehran", "Jafari"
  // Qatar usually works fine with "Makkah" / "MWL". Start with "Makkah".
  const prayTimes = new PrayTimes("Makkah");

  const prefs = {
    use24h: localStorage.getItem("clock_use24h") === "1",
  };

  const els = {
    card: document.getElementById("card"),
    greeting: document.getElementById("greeting"),
    time: document.getElementById("time"),
    date: document.getElementById("date"),
    locPill: document.getElementById("locPill"),
    timesGrid: document.getElementById("timesGrid"),
    nextPrayerName: document.getElementById("nextPrayerName"),
    nextPrayerCountdown: document.getElementById("nextPrayerCountdown"),
    toggleFmt: document.getElementById("toggleFmt"),
    refreshLoc: document.getElementById("refreshLoc"),
  };

  function pad(n){ return n < 10 ? "0"+n : ""+n; }

  function setTheme(hours){
    els.card.classList.remove("day","night");

    if(hours < 12){
      els.greeting.textContent = "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± â˜€ï¸";
      els.card.classList.add("day");
    } else if(hours < 17){
      els.greeting.textContent = "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸŒ¤";
      els.card.classList.add("day");
    } else {
      els.greeting.textContent = "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸŒ™";
      els.card.classList.add("night");
    }
  }

  function formatClock(date){
    const h = date.getHours();
    const m = date.getMinutes();
    if(prefs.use24h) return `${pad(h)}:${pad(m)}`;

    const isPM = h >= 12;
    let hh = h % 12 || 12;
    return `${pad(hh)}:${pad(m)} ${isPM ? "PM" : "AM"}`;
  }

  function setDateLine(date){
    const options = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
    els.date.textContent = date.toLocaleDateString('ar-QA', options);
  }

  function parseTimeToDate(baseDate, hhmm){
    // hhmm is "HH:MM" in 24h from PrayTimes by default; we will force 24h output.
    const [hh, mm] = hhmm.split(":").map(x => parseInt(x, 10));
    const d = new Date(baseDate);
    d.setHours(hh, mm, 0, 0);
    return d;
  }

  function msToHMS(ms){
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    // in widget, hh:mm:ss looks nice
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  function renderPrayerTimes(now){
    // Force 24h output from PrayTimes so parsing is consistent:
    // format: "24h" returns "HH:MM"
    const times = prayTimes.getTimes(now, [coords.lat, coords.lng], now.getTimezoneOffset() / -60, 0, "24h");

    // You can include all, but we'll show the main ones:
    const list = [
      ["Ø§Ù„ÙØ¬Ø±", times.fajr],
      ["Ø§Ù„Ø´Ø±ÙˆÙ‚", times.sunrise],
      ["Ø§Ù„Ø¸Ù‡Ø±", times.dhuhr],
      ["Ø§Ù„Ø¹ØµØ±", times.asr],
      ["Ø§Ù„Ù…ØºØ±Ø¨", times.maghrib],
      ["Ø§Ù„Ø¹Ø´Ø§Ø¡", times.isha],
    ];

    // Render grid
    els.timesGrid.innerHTML = "";
    for (const [name, t] of list){
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `<span>${name}</span><span>${displayAdhanTime(now, t)}</span>`;
      els.timesGrid.appendChild(item);
    }

    // Next prayer logic (skip sunrise as "prayer", but keep it as milestone if you like)
    const prayerOrder = [
      ["Ø§Ù„ÙØ¬Ø±", times.fajr],
      ["Ø§Ù„Ø¸Ù‡Ø±", times.dhuhr],
      ["Ø§Ù„Ø¹ØµØ±", times.asr],
      ["Ø§Ù„Ù…ØºØ±Ø¨", times.maghrib],
      ["Ø§Ù„Ø¹Ø´Ø§Ø¡", times.isha],
    ];

    let next = null;

    for (const [name, t] of prayerOrder){
      const dt = parseTimeToDate(now, t);
      if (dt > now){
        next = { name, at: dt };
        break;
      }
    }

    // If none left today, next is tomorrow fajr
    if(!next){
      const tomorrow = new Date(now);
      tomorrow.setDate(now.getDate() + 1);
      const timesTomorrow = prayTimes.getTimes(tomorrow, [coords.lat, coords.lng], tomorrow.getTimezoneOffset() / -60, 0, "24h");
      next = { name: "Ø§Ù„ÙØ¬Ø±", at: parseTimeToDate(tomorrow, timesTomorrow.fajr) };
    }

    els.nextPrayerName.textContent = `${next.name} â€” ${displayAdhanTime(now, toHHMM(next.at))}`;
    updateCountdown(next.at);
  }

  function toHHMM(date){
    return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function displayAdhanTime(baseDate, hhmm24){
    // Show adhan times in same preference (12/24)
    const d = parseTimeToDate(baseDate, hhmm24);
    if(prefs.use24h) return toHHMM(d);

    let h = d.getHours();
    const m = d.getMinutes();
    const isPM = h >= 12;
    h = h % 12 || 12;
    return `${pad(h)}:${pad(m)} ${isPM ? "PM" : "AM"}`;
  }

  let countdownTarget = null;
  function updateCountdown(targetDate){
    countdownTarget = targetDate;
  }

  function tick(){
    const now = new Date();

    setTheme(now.getHours());
    els.time.textContent = formatClock(now);
    setDateLine(now);

    if (countdownTarget){
      els.nextPrayerCountdown.textContent = msToHMS(countdownTarget - now);
      // when it reaches zero, refresh times
      if ((countdownTarget - now) <= 0) {
        renderPrayerTimes(new Date());
      }
    }
  }

  function scheduleExactMinuteAndSecond(){
    // clock: we tick each second for countdown, but it's light
    tick();

    // align to next second boundary for smoother countdown
    const now = new Date();
    const msToNextSecond = 1000 - now.getMilliseconds();
    setTimeout(() => {
      tick();
      setInterval(tick, 1000);
    }, msToNextSecond);
  }

  function setLocationLabel(name){
    locationLabel = name;
    els.locPill.textContent = `ğŸ“ ${name}`;
  }

  function requestGeolocation(){
    if(!navigator.geolocation){
      setLocationLabel("Ø§Ù„Ø¯ÙˆØ­Ø© (Ø§ÙØªØ±Ø§Ø¶ÙŠ)");
      renderPrayerTimes(new Date());
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        setLocationLabel("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
        renderPrayerTimes(new Date());
      },
      () => {
        setLocationLabel("Ø§Ù„Ø¯ÙˆØ­Ø© (Ø§ÙØªØ±Ø§Ø¶ÙŠ)");
        renderPrayerTimes(new Date());
      },
      { enableHighAccuracy: false, timeout: 6000, maximumAge: 3600000 }
    );
  }

  // Controls
  els.toggleFmt.addEventListener("click", () => {
    prefs.use24h = !prefs.use24h;
    localStorage.setItem("clock_use24h", prefs.use24h ? "1" : "0");
    renderPrayerTimes(new Date());
    tick();
  });

  els.refreshLoc.addEventListener("click", () => {
    requestGeolocation();
  });

  // Init
  setLocationLabel("Ø§Ù„Ø¯ÙˆØ­Ø©");
  requestGeolocation();
  renderPrayerTimes(new Date());
  scheduleExactMinuteAndSecond();
</script>
</body>
</html>
